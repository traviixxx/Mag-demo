# magnolia-helm

Helm Chart for Magnolia CMS.

This chart deploys a Magnolia CMS instance (author or public) and if desired
configures it to use a data base for its backend storage.

It's designed for one signle author and one single public instance. Multiple
public instances are work in progress.

## Configuration

The tomcat setup is derived from the public tomcat helm chart and uses init
containers the copy the actual webapp to the `webapps` folder.

### Rescue mode

To enable the [Groovy Rescue Console](https://documentation.magnolia-cms.com/display/DOCS61/Groovy+module#Groovymodule-RescueApp), deploy your Helm
release with the following flag:

```yaml
magnoliaAuthor:
    rescueMode: true
```

This only takes effect if Magnolia is already installed.

### Docker Image configuration

You can specify the tomcat image and tag in the values:

```yaml
image:
  tomcat:
    repository: tomcat
    tag: "9-jre11-slim"
  #...
```

The actual webapp is specified here:

```yaml
image:
  webarchive:
    repository: registry.gitlab.com/fastforward-websolutions/k8s/next-deployment
    tag: latest
  #...
```

The init container is expected to have an already "exploded" webapp in
`/magnolia`. Files in there will be copied into the `webapps` when starting tomcat.

To pull from private Docker registry (e.g. GitLab), you have to create a docker-registry secret:

```bash
kubectl create secret docker-registry gitlab-registry --docker-server=https://registry.gitlab.com --docker-username=<username> --docker-password=<password or token>
```

To use the token from above, specify `pullSecrets` inside `image:` section like the following:

```yaml
image:
  #...
  pullSecrets:
    - name: gitlab-registry
```

### Persistence

In the `magnoliaPublic/Author:` sections of the values you can configure the
Magnolia instances (public and author). This is an example with PostgreSQL as a
backend data base and it's the default.

```yaml
magnoliaAuthor:
  db:
    enabled: true
    repository: postgres
    tag: 11.5-alpine
    type: postgres
    name: author
    persistence:
      enabled: true
      size: 10Gi
```

If you enable persistence a PVC is created and you can also specify the
StorageClass. Each instance (author and public) only gets one single db.

If you like to enable shared database (aka [Jackrabbit Clustering](https://wiki.magnolia-cms.com/display/WIKI/Setting+up+a+Jackrabbit+Clustering)), you can configure the shared workspaces and db connection (same as above) like the following:

```yaml
sharedDb:
  enabled: false
  workspaces:
    - form2db
    - shop
  db:
    ...
```

### Libraries

If you need additional libraries (jars) you can specify them in the `jars:`
array.

To configure logging, you can use the following section:

```yaml
magnoliaAuthor:
  logging:
    level: DEBUG
    pattern: '{"level":"%p","timestamp":"%d{ISO8601}","file":"%c:%L","message":"%m"}%n'
    loggers:
      - name: my-logger
        level: ERROR
```

Under `loggers` it's possible to define additional loggers with the respective value.

### Convention expected from init containers

This chart expects the init container to contain an `/init.sh` script which is
called as the only command. As of now the only tasks expected from init
containers is to copy some files to a target directory specified by the env var
`INIT_DEST`.

## Monitoring / Liveness

As a default, we monitor the public instance via a call to `/` for liveness. You
can change these settings in the `magnoliaPublic/Author` dicts:

```yaml
magnoliaPublic:
  #...
  livenessProbe:
    path: /author
    port: 8080
    failureThreshold: 4
    initialDelaySeconds: 120
    timeoutSeconds: 10
    periodSeconds: 30
```

## TLS

When run in a Kubernetes environment we expect `cert-manager` to be present and
the ingress object should contain all annotations necessary for the cert manager
to issue certificates with Let's Encrypt.

You have to first specify the host names you want certificates for and uncomment
the annotation used by cert-manager to auto-issue certificates from Let's encrypt:

```yaml
ingress:
  enabled: True
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: test.k8s.example.com
      paths:
        - /
  tls:
    - hosts:
      - test.k8s.example.com
```

### Config Maps

`magnolia.properties` and a corresponding `server.xml` file for the persistence
layer is generated and stored as a ConfigMap. It will be mounted in the
container when run.

### Activation keypair generation

#### Technical background

Magnolia uses a public/private key system for content activation from author to public instances. If that key is nonexistent on the first boot it will be generated by Magnolia itself. While this is convenient it makes the application stateful (this is why it's a `kind: StatefulSet` and not a `kind: Deployment`). Generating a RSA key out of a passphrase is theoretically possible but not easy (nor secure) to do.

#### Automatically generated key

This is the easiest approach. A PVC will be requested by the pod and mounted for the purpose of storing the automatically generated activation key. You don't have to configure anything for this and it is the default.

#### Secrets

You can specify which secret the pods should be looking for to mount the key `.properties` file at the correct location. The format of the activation key file is like follows:

```text
#generated 09.May.2020 04:55 by superuser
#Sat May 09 16:55:03 CEST 2020
key.private=30820277020100300...
key.public=30819F300D06092A8648...
```

You can manually generate it like explained below:

#### Direct key input

**⚠️We do not recommend to use the following approach. This is documented for backwards compatibility reasons. Use secrets or secret injection with a key management server instead.**

Magnolia requires RSA keypair properties for the publication mechanism. You
can generate a keypair e.g. with `openssl`. **Magnolia can handle at most 1024 bit key length:**

```bash
openssl genrsa -out temp/key.pem 1024
openssl rsa -in temp/key.pem -pubout -out temp/pubkey.pem
```

This will store the keys in PEM format and you can use them as Hex-encoded Helm Chart values:

```bash
--set magnoliaAuthor.activation.privateKey=`cat temp/key.pem | hexdump -e '"%X"'`
--set magnoliaAuthor.activation.publicKey=`cat temp/pubkey.pem | hexdump -e '"%X"'`
```

## Status

This chart is currently used in production. We will adhere to the semver standard and try to maintain backwards compatiblity within major releases.

## Legal Notes

Magnolia, Magnolia Blossom, Magnolia and the Magnolia logo are registered
trademark or trademarks of Magnolia International Ltd.
