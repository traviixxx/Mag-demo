---
steps:
  - remove_default_subscriber
  - add_new_subscriber
  - pubkey
  - baseURL
  - change_superuser_pw

remove_sub:
  step: remove_default_subscriber
  method: delete
  path: "config/modules/publishing-core/config/receivers/magnoliaPublic8080"

{{- if .Env.MGNL_ACTIVATION_PUBKEY }}
set_pubkey:
  step: pubkey
  method: post
  path: "config/server/activation"
  allow_failure: false
  data:
    properties:
      - name: class
        type: String
        values:
         - "info.magnolia.publishing.manager.ActivationManagerAdapter"
      - name: publicKey
        type: String
        values:
          - {{ .Env.MGNL_ACTIVATION_PUBKEY | pubkey }}
{{- end }}

{{- if .Env.MGNL_DEFAULT_BASE_URL }}
setDefaultBaseURL:
  step: baseURL
  method: "post"
  path: "config/server"
  data:
    properties:
      - name: defaultBaseUrl
        type: String
        values:
          - {{ .Env.MGNL_DEFAULT_BASE_URL | quote }}
{{- end }}

updateSuperuserPw:
  step: change_superuser_pw
  method: "post"
  path: "users/system/superuser"
  allow_failure: false
  data:
    properties:
      - name: pswd
        type: String
        values: [
          {{ bcrypt (.Env.MGNLBOOT_NEW_SUPERUSER_PW) | quote }}
        ]
