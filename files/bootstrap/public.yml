---
steps:
  - add_new_subscriber
  - pubkey
  - change_superuser_pw

add_new_subs:
  step: add_new_subscriber
  method: put
  host: {{ printf "%s/author" .Env.MGNLBOOT_AUTHOR_INSTANCE }}
  username: superuser  # TODO: make this a variable
  password: {{ .Env.MGNLBOOT_AUTHOR_SUPERUSER_PW | quote }}
  path: "config/modules/publishing-core/config/receivers"
  data:
    name: {{ .Env.HOSTNAME | quote }}
    type: "mgnl:contentNode"
    properties:
      - name: url
        type: String
        values:
          - {{ .Env.MGNLBOOT_PUBLIC_INSTANCE }}
      - name: enabled
        type: String
        values:
          - "true"

{{- if .Env.MGNL_ACTIVATION_PUBKEY }}
set_pubkey:
  step: pubkey
  method: post
  path: "config/server/activation"
  allow_failure: false
  data:
    properties:
      - name: class
        type: String
        values:
         - "info.magnolia.publishing.manager.ActivationManagerAdapter"
      - name: publicKey
        type: String
        values:
          - {{ .Env.MGNL_ACTIVATION_PUBKEY | pubkey }}
{{- end }}

updateSuperuserPw:
  step: change_superuser_pw
  method: "post"
  path: "users/system/superuser"
  allow_failure: false
  data:
    properties:
      - name: pswd
        type: String
        values: [
          {{ bcrypt (.Env.MGNLBOOT_NEW_SUPERUSER_PW) | quote }}
        ]
