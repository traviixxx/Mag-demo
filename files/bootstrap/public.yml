---
endpoints:
  - name: magnolia-public
    url: http://localhost:8080{{ .Env.MGNL_CONTEXT_PATH | default "/" }}
  - name: magnolia-author
    url: {{ .Env.MGNLBOOT_AUTHOR_INSTANCE }}

playbook:
  - name: add_new_subs
    method: put
    endpoints:
      - magnolia-author
    username: {{ .Env.MGNLBOOT_AUTHOR_SUPERUSER_NAME | default "superuser" }}
    password: {{ .Env.MGNLBOOT_AUTHOR_SUPERUSER_PW | quote }}
    path: "config/modules/publishing-core/config/receivers"
    data:
      name: {{ .Env.HOSTNAME | quote }}
      type: "mgnl:contentNode"
      properties:
        - name: url
          type: String
          values:
            - "http://{{ .Env.HOSTNAME }}.{{ .Env.MGNLBOOT_PUBLIC_SERVICE_NAME }}:8765/"
        - name: enabled
          type: String
          values:
            - "true"

  - name: updateSuperuserPw
    endpoints:
      - magnolia-public
    method: "post"
    username: {{ .Env.MGNLBOOT_SUPERUSER_NAME | default "superuser" }}
    password: {{ .Env.MGNLBOOT_SUPERUSER_PW | default "superuser" }}
    path: "users/system/{{ .Env.MGNLBOOT_SUPERUSER_NAME | default "superuser" }}"
    allow_failure: true
    data:
      properties:
        - name: pswd
          type: String
          values: [
            {{ bcrypt (.Env.MGNLBOOT_NEW_SUPERUSER_PW) | quote }}
          ]

  {{- if .Env.MGNL_ACTIVATION_PUBKEY }}
  - name: set_pubkey
    endpoints:
      - magnolia-public
    method: post
    username: {{ .Env.MGNLBOOT_SUPERUSER_NAME | default "superuser" }}
    password: {{ .Env.MGNLBOOT_NEW_SUPERUSER_PW | quote }}
    path: "config/server/activation"
    allow_failure: false
    data:
      properties:
        - name: class
          type: String
          values:
          - "info.magnolia.publishing.manager.ActivationManagerAdapter"
        - name: publicKey
          type: String
          values:
            - {{ .Env.MGNL_ACTIVATION_PUBKEY | pubkey }}
  {{- end }}


  {{- if .Env.MGNL_DEFAULT_BASE_URL }}
  - name: setDefaultBaseURL
    endpoints:
      - magnolia-public
    method: "post"
    username: {{ .Env.MGNLBOOT_SUPERUSER_NAME | default "superuser" }}
    password: {{ .Env.MGNLBOOT_NEW_SUPERUSER_PW | quote }}
    path: "config/server"
    data:
      properties:
        - name: defaultBaseUrl
          type: String
          values:
            - {{ .Env.MGNL_DEFAULT_BASE_URL | quote }}
  {{- end }}
